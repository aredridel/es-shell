Only in es-0.9-beta1: .cvsignore
Common subdirectories: es-0.9-beta1/CVS and es-0.9-job-alpha2/CVS
Only in es-0.9-beta1: Makefile
Only in es-0.9-job-alpha2/: Makefile~
Only in es-0.9-beta1: access.o
Only in es-0.9-beta1: closure.o
Only in es-0.9-beta1: config.cache
Only in es-0.9-beta1: config.h
Only in es-0.9-beta1: config.log
Only in es-0.9-beta1: config.status
diff -u es-0.9-beta1/configure es-0.9-job-alpha2/configure
--- es-0.9-beta1/configure	1997-08-13 12:35:06.000000000 -0600
+++ es-0.9-job-alpha2/configure	2006-11-27 10:08:23.000000000 -0600
@@ -1,7 +1,7 @@
 #! /bin/sh
 
 # Guess values for system-dependent variables and create Makefiles.
-# Generated automatically using autoconf version 2.12 
+# Generated automatically using autoconf version 2.13 
 # Copyright (C) 1992, 93, 94, 95, 96 Free Software Foundation, Inc.
 #
 # This configure script is free software; the Free Software Foundation
@@ -12,7 +12,7 @@
 ac_default_prefix=/usr/local
 # Any additions from configure.in:
 ac_help="$ac_help
---with-readline		Use GNU Readline"
+--without-readline		Use GNU Readline"
 ac_help="$ac_help
 --with-editline		Use the Editline library"
 
@@ -53,6 +53,7 @@
 # Initialize some other variables.
 subdirs=
 MFLAGS= MAKEFLAGS=
+SHELL=${CONFIG_SHELL-/bin/sh}
 # Maximum number of lines to put in a shell here document.
 ac_max_here_lines=12
 
@@ -336,7 +337,7 @@
     verbose=yes ;;
 
   -version | --version | --versio | --versi | --vers)
-    echo "configure generated by autoconf version 2.12"
+    echo "configure generated by autoconf version 2.13"
     exit 0 ;;
 
   -with-* | --with-*)
@@ -506,9 +507,11 @@
 # CFLAGS is not in ac_cpp because -g, -O, etc. are not valid cpp options.
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='${CC-cc} -c $CFLAGS $CPPFLAGS conftest.$ac_ext 1>&5'
-ac_link='${CC-cc} -o conftest $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS 1>&5'
+ac_link='${CC-cc} -o conftest${ac_exeext} $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS 1>&5'
 cross_compiling=$ac_cv_prog_cc_cross
 
+ac_exeext=
+ac_objext=o
 if (echo "testing\c"; echo 1,2,3) | grep c >/dev/null; then
   # Stardent Vistra SVR4 grep lacks -e, says ghazi@caip.rutgers.edu.
   if (echo -n testing; echo 1,2,3) | sed s/-n/xn/ | grep xn >/dev/null; then
@@ -526,14 +529,13 @@
 
 
 
-
-use_readline=no
+use_readline=yes
 use_editline=no
-
+	
 # Check whether --with-readline or --without-readline was given.
 if test "${with_readline+set}" = set; then
   withval="$with_readline"
-  use_readline=yes
+  use_readline=no
 fi
 
 # Check whether --with-editline or --without-editline was given.
@@ -564,26 +566,26 @@
 
 
 # Make sure we can run config.sub.
-if $ac_config_sub sun4 >/dev/null 2>&1; then :
+if ${CONFIG_SHELL-/bin/sh} $ac_config_sub sun4 >/dev/null 2>&1; then :
 else { echo "configure: error: can not run $ac_config_sub" 1>&2; exit 1; }
 fi
 
 echo $ac_n "checking host system type""... $ac_c" 1>&6
-echo "configure:573: checking host system type" >&5
+echo "configure:575: checking host system type" >&5
 
 host_alias=$host
 case "$host_alias" in
 NONE)
   case $nonopt in
   NONE)
-    if host_alias=`$ac_config_guess`; then :
+    if host_alias=`${CONFIG_SHELL-/bin/sh} $ac_config_guess`; then :
     else { echo "configure: error: can not guess host type; you must specify one" 1>&2; exit 1; }
     fi ;;
   *) host_alias=$nonopt ;;
   esac ;;
 esac
 
-host=`$ac_config_sub $host_alias`
+host=`${CONFIG_SHELL-/bin/sh} $ac_config_sub $host_alias`
 host_cpu=`echo $host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\1/'`
 host_vendor=`echo $host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\2/'`
 host_os=`echo $host | sed 's/^\([^-]*\)-\([^-]*\)-\(.*\)$/\3/'`
@@ -603,20 +605,23 @@
 # Extract the first word of "gcc", so it can be a program name with args.
 set dummy gcc; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:607: checking for $ac_word" >&5
+echo "configure:609: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_CC'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
-  for ac_dir in `echo $PATH | tr : '\012'`; do
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS=":"
+  ac_dummy="$PATH"
+  for ac_dir in $ac_dummy; do
     test -z "$ac_dir" && ac_dir=.
     if test -f $ac_dir/$ac_word; then
       ac_cv_prog_CC="gcc"
       break
     fi
   done
+  IFS="$ac_save_ifs"
 fi
 fi
 CC="$ac_cv_prog_CC"
@@ -630,15 +635,17 @@
   # Extract the first word of "cc", so it can be a program name with args.
 set dummy cc; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:634: checking for $ac_word" >&5
+echo "configure:639: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_CC'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   if test -n "$CC"; then
   ac_cv_prog_CC="$CC" # Let the user override the test.
 else
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS=":"
   ac_prog_rejected=no
-  for ac_dir in `echo $PATH | tr : '\012'`; do
+  ac_dummy="$PATH"
+  for ac_dir in $ac_dummy; do
     test -z "$ac_dir" && ac_dir=.
     if test -f $ac_dir/$ac_word; then
       if test "$ac_dir/$ac_word" = "/usr/ucb/cc"; then
@@ -649,6 +656,7 @@
       break
     fi
   done
+  IFS="$ac_save_ifs"
 if test $ac_prog_rejected = yes; then
   # We found a bogon in the path, so make sure we never use it.
   set dummy $ac_cv_prog_CC
@@ -672,25 +680,61 @@
   echo "$ac_t""no" 1>&6
 fi
 
+  if test -z "$CC"; then
+    case "`uname -s`" in
+    *win32* | *WIN32*)
+      # Extract the first word of "cl", so it can be a program name with args.
+set dummy cl; ac_word=$2
+echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
+echo "configure:690: checking for $ac_word" >&5
+if eval "test \"`echo '$''{'ac_cv_prog_CC'+set}'`\" = set"; then
+  echo $ac_n "(cached) $ac_c" 1>&6
+else
+  if test -n "$CC"; then
+  ac_cv_prog_CC="$CC" # Let the user override the test.
+else
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS=":"
+  ac_dummy="$PATH"
+  for ac_dir in $ac_dummy; do
+    test -z "$ac_dir" && ac_dir=.
+    if test -f $ac_dir/$ac_word; then
+      ac_cv_prog_CC="cl"
+      break
+    fi
+  done
+  IFS="$ac_save_ifs"
+fi
+fi
+CC="$ac_cv_prog_CC"
+if test -n "$CC"; then
+  echo "$ac_t""$CC" 1>&6
+else
+  echo "$ac_t""no" 1>&6
+fi
+ ;;
+    esac
+  fi
   test -z "$CC" && { echo "configure: error: no acceptable cc found in \$PATH" 1>&2; exit 1; }
 fi
 
 echo $ac_n "checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works""... $ac_c" 1>&6
-echo "configure:680: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works" >&5
+echo "configure:722: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) works" >&5
 
 ac_ext=c
 # CFLAGS is not in ac_cpp because -g, -O, etc. are not valid cpp options.
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='${CC-cc} -c $CFLAGS $CPPFLAGS conftest.$ac_ext 1>&5'
-ac_link='${CC-cc} -o conftest $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS 1>&5'
+ac_link='${CC-cc} -o conftest${ac_exeext} $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS 1>&5'
 cross_compiling=$ac_cv_prog_cc_cross
 
-cat > conftest.$ac_ext <<EOF
-#line 690 "configure"
+cat > conftest.$ac_ext << EOF
+
+#line 733 "configure"
 #include "confdefs.h"
+
 main(){return(0);}
 EOF
-if { (eval echo configure:694: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:738: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   ac_cv_prog_cc_works=yes
   # If we can't run a trivial program, we are probably using a cross compiler.
   if (./conftest; exit) 2>/dev/null; then
@@ -704,18 +748,24 @@
   ac_cv_prog_cc_works=no
 fi
 rm -fr conftest*
+ac_ext=c
+# CFLAGS is not in ac_cpp because -g, -O, etc. are not valid cpp options.
+ac_cpp='$CPP $CPPFLAGS'
+ac_compile='${CC-cc} -c $CFLAGS $CPPFLAGS conftest.$ac_ext 1>&5'
+ac_link='${CC-cc} -o conftest${ac_exeext} $CFLAGS $CPPFLAGS $LDFLAGS conftest.$ac_ext $LIBS 1>&5'
+cross_compiling=$ac_cv_prog_cc_cross
 
 echo "$ac_t""$ac_cv_prog_cc_works" 1>&6
 if test $ac_cv_prog_cc_works = no; then
   { echo "configure: error: installation or configuration problem: C compiler cannot create executables." 1>&2; exit 1; }
 fi
 echo $ac_n "checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler""... $ac_c" 1>&6
-echo "configure:714: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler" >&5
+echo "configure:764: checking whether the C compiler ($CC $CFLAGS $LDFLAGS) is a cross-compiler" >&5
 echo "$ac_t""$ac_cv_prog_cc_cross" 1>&6
 cross_compiling=$ac_cv_prog_cc_cross
 
 echo $ac_n "checking whether we are using GNU C""... $ac_c" 1>&6
-echo "configure:719: checking whether we are using GNU C" >&5
+echo "configure:769: checking whether we are using GNU C" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_gcc'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -724,7 +774,7 @@
   yes;
 #endif
 EOF
-if { ac_try='${CC-cc} -E conftest.c'; { (eval echo configure:728: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }; } | egrep yes >/dev/null 2>&1; then
+if { ac_try='${CC-cc} -E conftest.c'; { (eval echo configure:778: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }; } | egrep yes >/dev/null 2>&1; then
   ac_cv_prog_gcc=yes
 else
   ac_cv_prog_gcc=no
@@ -735,11 +785,15 @@
 
 if test $ac_cv_prog_gcc = yes; then
   GCC=yes
-  ac_test_CFLAGS="${CFLAGS+set}"
-  ac_save_CFLAGS="$CFLAGS"
-  CFLAGS=
-  echo $ac_n "checking whether ${CC-cc} accepts -g""... $ac_c" 1>&6
-echo "configure:743: checking whether ${CC-cc} accepts -g" >&5
+else
+  GCC=
+fi
+
+ac_test_CFLAGS="${CFLAGS+set}"
+ac_save_CFLAGS="$CFLAGS"
+CFLAGS=
+echo $ac_n "checking whether ${CC-cc} accepts -g""... $ac_c" 1>&6
+echo "configure:797: checking whether ${CC-cc} accepts -g" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_cc_g'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -754,16 +808,20 @@
 fi
 
 echo "$ac_t""$ac_cv_prog_cc_g" 1>&6
-  if test "$ac_test_CFLAGS" = set; then
-    CFLAGS="$ac_save_CFLAGS"
-  elif test $ac_cv_prog_cc_g = yes; then
+if test "$ac_test_CFLAGS" = set; then
+  CFLAGS="$ac_save_CFLAGS"
+elif test $ac_cv_prog_cc_g = yes; then
+  if test "$GCC" = yes; then
     CFLAGS="-g -O2"
   else
-    CFLAGS="-O2"
+    CFLAGS="-g"
   fi
 else
-  GCC=
-  test "${CFLAGS+set}" = set || CFLAGS="-g"
+  if test "$GCC" = yes; then
+    CFLAGS="-O2"
+  else
+    CFLAGS=
+  fi
 fi
 
 # Find a good install program.  We prefer a C program (faster),
@@ -773,28 +831,30 @@
 # SunOS /usr/etc/install
 # IRIX /sbin/install
 # AIX /bin/install
+# AIX 4 /usr/bin/installbsd, which doesn't work without a -g flag
 # AFS /usr/afsws/bin/install, which mishandles nonexistent args
 # SVR4 /usr/ucb/install, which tries to use the nonexistent group "staff"
 # ./install, which can be erroneously created by make from ./install.sh.
 echo $ac_n "checking for a BSD compatible install""... $ac_c" 1>&6
-echo "configure:781: checking for a BSD compatible install" >&5
+echo "configure:840: checking for a BSD compatible install" >&5
 if test -z "$INSTALL"; then
 if eval "test \"`echo '$''{'ac_cv_path_install'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
-    IFS="${IFS= 	}"; ac_save_IFS="$IFS"; IFS="${IFS}:"
+    IFS="${IFS= 	}"; ac_save_IFS="$IFS"; IFS=":"
   for ac_dir in $PATH; do
     # Account for people who put trailing slashes in PATH elements.
     case "$ac_dir/" in
     /|./|.//|/etc/*|/usr/sbin/*|/usr/etc/*|/sbin/*|/usr/afsws/bin/*|/usr/ucb/*) ;;
     *)
       # OSF1 and SCO ODT 3.0 have their own names for install.
-      for ac_prog in ginstall installbsd scoinst install; do
+      # Don't use installbsd from OSF since it installs stuff as root
+      # by default.
+      for ac_prog in ginstall scoinst install; do
         if test -f $ac_dir/$ac_prog; then
 	  if test $ac_prog = install &&
             grep dspmsg $ac_dir/$ac_prog >/dev/null 2>&1; then
 	    # AIX install.  It has an incompatible calling convention.
-	    # OSF/1 installbsd also uses dspmsg, but is usable.
 	    :
 	  else
 	    ac_cv_path_install="$ac_dir/$ac_prog -c"
@@ -824,6 +884,8 @@
 # It thinks the first close brace ends the variable substitution.
 test -z "$INSTALL_PROGRAM" && INSTALL_PROGRAM='${INSTALL}'
 
+test -z "$INSTALL_SCRIPT" && INSTALL_SCRIPT='${INSTALL_PROGRAM}'
+
 test -z "$INSTALL_DATA" && INSTALL_DATA='${INSTALL} -m 644'
 
 for ac_prog in 'bison -y' byacc
@@ -831,20 +893,23 @@
 # Extract the first word of "$ac_prog", so it can be a program name with args.
 set dummy $ac_prog; ac_word=$2
 echo $ac_n "checking for $ac_word""... $ac_c" 1>&6
-echo "configure:835: checking for $ac_word" >&5
+echo "configure:897: checking for $ac_word" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_YACC'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   if test -n "$YACC"; then
   ac_cv_prog_YACC="$YACC" # Let the user override the test.
 else
-  for ac_dir in `echo $PATH | tr : '\012'`; do
+  IFS="${IFS= 	}"; ac_save_ifs="$IFS"; IFS=":"
+  ac_dummy="$PATH"
+  for ac_dir in $ac_dummy; do
     test -z "$ac_dir" && ac_dir=.
     if test -f $ac_dir/$ac_word; then
       ac_cv_prog_YACC="$ac_prog"
       break
     fi
   done
+  IFS="$ac_save_ifs"
 fi
 fi
 YACC="$ac_cv_prog_YACC"
@@ -861,7 +926,7 @@
 
 
 echo $ac_n "checking for /dev/fd filesystem""... $ac_c" 1>&6
-echo "configure:865: checking for /dev/fd filesystem" >&5
+echo "configure:930: checking for /dev/fd filesystem" >&5
 if eval "test \"`echo '$''{'es_cv_sys_dev_fd'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -879,7 +944,7 @@
 # Pull the hash mark out of the macro call to avoid m4 problems.
 ac_msg="whether #! works in shell scripts"
 echo $ac_n "checking $ac_msg""... $ac_c" 1>&6
-echo "configure:883: checking $ac_msg" >&5
+echo "configure:948: checking $ac_msg" >&5
 if eval "test \"`echo '$''{'ac_cv_sys_interpreter'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -897,6 +962,7 @@
 fi
 
 echo "$ac_t""$ac_cv_sys_interpreter" 1>&6
+interpval="$ac_cv_sys_interpreter"
 
 if test "$ac_cv_sys_interpreter" = yes
 then
@@ -909,7 +975,7 @@
 
 
 echo $ac_n "checking for getpwuid in -lsun""... $ac_c" 1>&6
-echo "configure:913: checking for getpwuid in -lsun" >&5
+echo "configure:979: checking for getpwuid in -lsun" >&5
 ac_lib_var=`echo sun'_'getpwuid | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -917,7 +983,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lsun  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 921 "configure"
+#line 987 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -928,7 +994,7 @@
 getpwuid()
 ; return 0; }
 EOF
-if { (eval echo configure:932: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:998: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -958,8 +1024,90 @@
 
 if test "$use_readline" = yes || test "$use_editline" = yes
 then
-	echo $ac_n "checking for main in -lterminfo""... $ac_c" 1>&6
-echo "configure:963: checking for main in -lterminfo" >&5
+	echo $ac_n "checking for main in -lncurses""... $ac_c" 1>&6
+echo "configure:1029: checking for main in -lncurses" >&5
+ac_lib_var=`echo ncurses'_'main | sed 'y%./+-%__p_%'`
+if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
+  echo $ac_n "(cached) $ac_c" 1>&6
+else
+  ac_save_LIBS="$LIBS"
+LIBS="-lncurses  $LIBS"
+cat > conftest.$ac_ext <<EOF
+#line 1037 "configure"
+#include "confdefs.h"
+
+int main() {
+main()
+; return 0; }
+EOF
+if { (eval echo configure:1044: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
+  rm -rf conftest*
+  eval "ac_cv_lib_$ac_lib_var=yes"
+else
+  echo "configure: failed program was:" >&5
+  cat conftest.$ac_ext >&5
+  rm -rf conftest*
+  eval "ac_cv_lib_$ac_lib_var=no"
+fi
+rm -f conftest*
+LIBS="$ac_save_LIBS"
+
+fi
+if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
+  echo "$ac_t""yes" 1>&6
+    ac_tr_lib=HAVE_LIB`echo ncurses | sed -e 's/[^a-zA-Z0-9_]/_/g' \
+    -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`
+  cat >> confdefs.h <<EOF
+#define $ac_tr_lib 1
+EOF
+
+  LIBS="-lncurses $LIBS"
+
+else
+  echo "$ac_t""no" 1>&6
+echo $ac_n "checking for main in -lcurses""... $ac_c" 1>&6
+echo "configure:1070: checking for main in -lcurses" >&5
+ac_lib_var=`echo curses'_'main | sed 'y%./+-%__p_%'`
+if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
+  echo $ac_n "(cached) $ac_c" 1>&6
+else
+  ac_save_LIBS="$LIBS"
+LIBS="-lcurses  $LIBS"
+cat > conftest.$ac_ext <<EOF
+#line 1078 "configure"
+#include "confdefs.h"
+
+int main() {
+main()
+; return 0; }
+EOF
+if { (eval echo configure:1085: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
+  rm -rf conftest*
+  eval "ac_cv_lib_$ac_lib_var=yes"
+else
+  echo "configure: failed program was:" >&5
+  cat conftest.$ac_ext >&5
+  rm -rf conftest*
+  eval "ac_cv_lib_$ac_lib_var=no"
+fi
+rm -f conftest*
+LIBS="$ac_save_LIBS"
+
+fi
+if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
+  echo "$ac_t""yes" 1>&6
+    ac_tr_lib=HAVE_LIB`echo curses | sed -e 's/^a-zA-Z0-9_/_/g' \
+    -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`
+  cat >> confdefs.h <<EOF
+#define $ac_tr_lib 1
+EOF
+
+  LIBS="-lcurses $LIBS"
+
+else
+  echo "$ac_t""no" 1>&6
+echo $ac_n "checking for main in -lterminfo""... $ac_c" 1>&6
+echo "configure:1111: checking for main in -lterminfo" >&5
 ac_lib_var=`echo terminfo'_'main | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -967,14 +1115,14 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lterminfo  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 971 "configure"
+#line 1119 "configure"
 #include "confdefs.h"
 
 int main() {
 main()
 ; return 0; }
 EOF
-if { (eval echo configure:978: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1126: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -989,7 +1137,7 @@
 fi
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-    ac_tr_lib=HAVE_LIB`echo terminfo | sed -e 's/[^a-zA-Z0-9_]/_/g' \
+    ac_tr_lib=HAVE_LIB`echo terminfo | sed -e 's/^a-zA-Z0-9_/_/g' \
     -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`
   cat >> confdefs.h <<EOF
 #define $ac_tr_lib 1
@@ -1001,8 +1149,8 @@
   echo "$ac_t""no" 1>&6
 fi
 
-	echo $ac_n "checking for main in -ltermcap""... $ac_c" 1>&6
-echo "configure:1006: checking for main in -ltermcap" >&5
+ 			echo $ac_n "checking for main in -ltermcap""... $ac_c" 1>&6
+echo "configure:1154: checking for main in -ltermcap" >&5
 ac_lib_var=`echo termcap'_'main | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1010,14 +1158,14 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ltermcap  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1014 "configure"
+#line 1162 "configure"
 #include "confdefs.h"
 
 int main() {
 main()
 ; return 0; }
 EOF
-if { (eval echo configure:1021: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1169: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1032,7 +1180,7 @@
 fi
 if eval "test \"`echo '$ac_cv_lib_'$ac_lib_var`\" = yes"; then
   echo "$ac_t""yes" 1>&6
-    ac_tr_lib=HAVE_LIB`echo termcap | sed -e 's/[^a-zA-Z0-9_]/_/g' \
+    ac_tr_lib=HAVE_LIB`echo termcap | sed -e 's/^a-zA-Z0-9_/_/g' \
     -e 'y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/'`
   cat >> confdefs.h <<EOF
 #define $ac_tr_lib 1
@@ -1044,10 +1192,16 @@
   echo "$ac_t""no" 1>&6
 fi
 
+		
+fi
+
+	
+fi
+
 	if test "$use_readline" = yes
 	then
 		echo $ac_n "checking for readline in -lreadline""... $ac_c" 1>&6
-echo "configure:1051: checking for readline in -lreadline" >&5
+echo "configure:1205: checking for readline in -lreadline" >&5
 ac_lib_var=`echo readline'_'readline | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1055,7 +1209,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lreadline  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1059 "configure"
+#line 1213 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1066,7 +1220,7 @@
 readline()
 ; return 0; }
 EOF
-if { (eval echo configure:1070: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1224: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1096,7 +1250,7 @@
 	elif test "$use_editline" = yes
 	then
 		echo $ac_n "checking for readline in -ledit""... $ac_c" 1>&6
-echo "configure:1100: checking for readline in -ledit" >&5
+echo "configure:1254: checking for readline in -ledit" >&5
 ac_lib_var=`echo edit'_'readline | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1104,7 +1258,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ledit  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1108 "configure"
+#line 1262 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1115,7 +1269,7 @@
 readline()
 ; return 0; }
 EOF
-if { (eval echo configure:1119: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1273: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1152,12 +1306,12 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr that defines DIR""... $ac_c" 1>&6
-echo "configure:1156: checking for $ac_hdr that defines DIR" >&5
+echo "configure:1310: checking for $ac_hdr that defines DIR" >&5
 if eval "test \"`echo '$''{'ac_cv_header_dirent_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1161 "configure"
+#line 1315 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <$ac_hdr>
@@ -1165,7 +1319,7 @@
 DIR *dirp = 0;
 ; return 0; }
 EOF
-if { (eval echo configure:1169: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:1323: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   eval "ac_cv_header_dirent_$ac_safe=yes"
 else
@@ -1190,7 +1344,7 @@
 # Two versions of opendir et al. are in -ldir and -lx on SCO Xenix.
 if test $ac_header_dirent = dirent.h; then
 echo $ac_n "checking for opendir in -ldir""... $ac_c" 1>&6
-echo "configure:1194: checking for opendir in -ldir" >&5
+echo "configure:1348: checking for opendir in -ldir" >&5
 ac_lib_var=`echo dir'_'opendir | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1198,7 +1352,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-ldir  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1202 "configure"
+#line 1356 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1209,7 +1363,7 @@
 opendir()
 ; return 0; }
 EOF
-if { (eval echo configure:1213: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1367: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1231,7 +1385,7 @@
 
 else
 echo $ac_n "checking for opendir in -lx""... $ac_c" 1>&6
-echo "configure:1235: checking for opendir in -lx" >&5
+echo "configure:1389: checking for opendir in -lx" >&5
 ac_lib_var=`echo x'_'opendir | sed 'y%./+-%__p_%'`
 if eval "test \"`echo '$''{'ac_cv_lib_$ac_lib_var'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
@@ -1239,7 +1393,7 @@
   ac_save_LIBS="$LIBS"
 LIBS="-lx  $LIBS"
 cat > conftest.$ac_ext <<EOF
-#line 1243 "configure"
+#line 1397 "configure"
 #include "confdefs.h"
 /* Override any gcc2 internal prototype to avoid an error.  */
 /* We use char because int might match the return type of a gcc2
@@ -1250,7 +1404,7 @@
 opendir()
 ; return 0; }
 EOF
-if { (eval echo configure:1254: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:1408: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_lib_$ac_lib_var=yes"
 else
@@ -1273,7 +1427,7 @@
 fi
 
 echo $ac_n "checking how to run the C preprocessor""... $ac_c" 1>&6
-echo "configure:1277: checking how to run the C preprocessor" >&5
+echo "configure:1431: checking how to run the C preprocessor" >&5
 # On Suns, sometimes $CPP names a directory.
 if test -n "$CPP" && test -d "$CPP"; then
   CPP=
@@ -1288,14 +1442,14 @@
   # On the NeXT, cc -E runs the code through the compiler's parser,
   # not just through cpp.
   cat > conftest.$ac_ext <<EOF
-#line 1292 "configure"
+#line 1446 "configure"
 #include "confdefs.h"
 #include <assert.h>
 Syntax Error
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1298: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
-ac_err=`grep -v '^ *+' conftest.out`
+{ (eval echo configure:1452: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
 if test -z "$ac_err"; then
   :
 else
@@ -1305,14 +1459,31 @@
   rm -rf conftest*
   CPP="${CC-cc} -E -traditional-cpp"
   cat > conftest.$ac_ext <<EOF
-#line 1309 "configure"
+#line 1463 "configure"
 #include "confdefs.h"
 #include <assert.h>
 Syntax Error
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1315: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
-ac_err=`grep -v '^ *+' conftest.out`
+{ (eval echo configure:1469: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
+if test -z "$ac_err"; then
+  :
+else
+  echo "$ac_err" >&5
+  echo "configure: failed program was:" >&5
+  cat conftest.$ac_ext >&5
+  rm -rf conftest*
+  CPP="${CC-cc} -nologo -E"
+  cat > conftest.$ac_ext <<EOF
+#line 1480 "configure"
+#include "confdefs.h"
+#include <assert.h>
+Syntax Error
+EOF
+ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
+{ (eval echo configure:1486: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
 if test -z "$ac_err"; then
   :
 else
@@ -1325,6 +1496,8 @@
 rm -f conftest*
 fi
 rm -f conftest*
+fi
+rm -f conftest*
   ac_cv_prog_CPP="$CPP"
 fi
   CPP="$ac_cv_prog_CPP"
@@ -1334,12 +1507,12 @@
 echo "$ac_t""$CPP" 1>&6
 
 echo $ac_n "checking for ANSI C header files""... $ac_c" 1>&6
-echo "configure:1338: checking for ANSI C header files" >&5
+echo "configure:1511: checking for ANSI C header files" >&5
 if eval "test \"`echo '$''{'ac_cv_header_stdc'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1343 "configure"
+#line 1516 "configure"
 #include "confdefs.h"
 #include <stdlib.h>
 #include <stdarg.h>
@@ -1347,8 +1520,8 @@
 #include <float.h>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1351: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
-ac_err=`grep -v '^ *+' conftest.out`
+{ (eval echo configure:1524: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
 if test -z "$ac_err"; then
   rm -rf conftest*
   ac_cv_header_stdc=yes
@@ -1364,7 +1537,7 @@
 if test $ac_cv_header_stdc = yes; then
   # SunOS 4.x string.h does not declare mem*, contrary to ANSI.
 cat > conftest.$ac_ext <<EOF
-#line 1368 "configure"
+#line 1541 "configure"
 #include "confdefs.h"
 #include <string.h>
 EOF
@@ -1382,7 +1555,7 @@
 if test $ac_cv_header_stdc = yes; then
   # ISC 2.0.2 stdlib.h does not declare free, contrary to ANSI.
 cat > conftest.$ac_ext <<EOF
-#line 1386 "configure"
+#line 1559 "configure"
 #include "confdefs.h"
 #include <stdlib.h>
 EOF
@@ -1403,7 +1576,7 @@
   :
 else
   cat > conftest.$ac_ext <<EOF
-#line 1407 "configure"
+#line 1580 "configure"
 #include "confdefs.h"
 #include <ctype.h>
 #define ISLOWER(c) ('a' <= (c) && (c) <= 'z')
@@ -1414,7 +1587,7 @@
 exit (0); }
 
 EOF
-if { (eval echo configure:1418: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:1591: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null
 then
   :
 else
@@ -1438,12 +1611,12 @@
 fi
 
 echo $ac_n "checking for sys/wait.h that is POSIX.1 compatible""... $ac_c" 1>&6
-echo "configure:1442: checking for sys/wait.h that is POSIX.1 compatible" >&5
+echo "configure:1615: checking for sys/wait.h that is POSIX.1 compatible" >&5
 if eval "test \"`echo '$''{'ac_cv_header_sys_wait_h'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1447 "configure"
+#line 1620 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/wait.h>
@@ -1459,7 +1632,7 @@
 s = WIFEXITED (s) ? WEXITSTATUS (s) : 1;
 ; return 0; }
 EOF
-if { (eval echo configure:1463: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:1636: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_header_sys_wait_h=yes
 else
@@ -1483,18 +1656,18 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:1487: checking for $ac_hdr" >&5
+echo "configure:1660: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1492 "configure"
+#line 1665 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1497: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
-ac_err=`grep -v '^ *+' conftest.out`
+{ (eval echo configure:1670: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
 if test -z "$ac_err"; then
   rm -rf conftest*
   eval "ac_cv_header_$ac_safe=yes"
@@ -1522,12 +1695,12 @@
 
 
 echo $ac_n "checking for working const""... $ac_c" 1>&6
-echo "configure:1526: checking for working const" >&5
+echo "configure:1699: checking for working const" >&5
 if eval "test \"`echo '$''{'ac_cv_c_const'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1531 "configure"
+#line 1704 "configure"
 #include "confdefs.h"
 
 int main() {
@@ -1576,7 +1749,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:1580: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:1753: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_c_const=yes
 else
@@ -1597,12 +1770,12 @@
 fi
 
 echo $ac_n "checking for uid_t in sys/types.h""... $ac_c" 1>&6
-echo "configure:1601: checking for uid_t in sys/types.h" >&5
+echo "configure:1774: checking for uid_t in sys/types.h" >&5
 if eval "test \"`echo '$''{'ac_cv_type_uid_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1606 "configure"
+#line 1779 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 EOF
@@ -1631,12 +1804,12 @@
 fi
 
 echo $ac_n "checking for size_t""... $ac_c" 1>&6
-echo "configure:1635: checking for size_t" >&5
+echo "configure:1808: checking for size_t" >&5
 if eval "test \"`echo '$''{'ac_cv_type_size_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1640 "configure"
+#line 1813 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #if STDC_HEADERS
@@ -1645,7 +1818,7 @@
 #endif
 EOF
 if (eval "$ac_cpp conftest.$ac_ext") 2>&5 |
-  egrep "size_t[^a-zA-Z_0-9]" >/dev/null 2>&1; then
+  egrep "(^|[^a-zA-Z_0-9])size_t[^a-zA-Z_0-9]" >/dev/null 2>&1; then
   rm -rf conftest*
   ac_cv_type_size_t=yes
 else
@@ -1665,7 +1838,7 @@
 
 
 echo $ac_n "checking type of array argument to getgroups""... $ac_c" 1>&6
-echo "configure:1669: checking type of array argument to getgroups" >&5
+echo "configure:1842: checking type of array argument to getgroups" >&5
 if eval "test \"`echo '$''{'ac_cv_type_getgroups'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -1673,7 +1846,7 @@
   ac_cv_type_getgroups=cross
 else
   cat > conftest.$ac_ext <<EOF
-#line 1677 "configure"
+#line 1850 "configure"
 #include "confdefs.h"
 
 /* Thanks to Mike Rendell for this test.  */
@@ -1698,7 +1871,7 @@
 }
 
 EOF
-if { (eval echo configure:1702: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:1875: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null
 then
     ac_cv_type_getgroups=gid_t
 else
@@ -1712,7 +1885,7 @@
 
 if test $ac_cv_type_getgroups = cross; then
         cat > conftest.$ac_ext <<EOF
-#line 1716 "configure"
+#line 1889 "configure"
 #include "confdefs.h"
 #include <unistd.h>
 EOF
@@ -1737,13 +1910,13 @@
 
 if test $ac_cv_prog_gcc = yes; then
     echo $ac_n "checking whether ${CC-cc} needs -traditional""... $ac_c" 1>&6
-echo "configure:1741: checking whether ${CC-cc} needs -traditional" >&5
+echo "configure:1914: checking whether ${CC-cc} needs -traditional" >&5
 if eval "test \"`echo '$''{'ac_cv_prog_gcc_traditional'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
     ac_pattern="Autoconf.*'x'"
   cat > conftest.$ac_ext <<EOF
-#line 1747 "configure"
+#line 1920 "configure"
 #include "confdefs.h"
 #include <sgtty.h>
 Autoconf TIOCGETP
@@ -1761,7 +1934,7 @@
 
   if test $ac_cv_prog_gcc_traditional = no; then
     cat > conftest.$ac_ext <<EOF
-#line 1765 "configure"
+#line 1938 "configure"
 #include "confdefs.h"
 #include <termio.h>
 Autoconf TCGETA
@@ -1786,18 +1959,18 @@
 do
 ac_safe=`echo "$ac_hdr" | sed 'y%./+-%__p_%'`
 echo $ac_n "checking for $ac_hdr""... $ac_c" 1>&6
-echo "configure:1790: checking for $ac_hdr" >&5
+echo "configure:1963: checking for $ac_hdr" >&5
 if eval "test \"`echo '$''{'ac_cv_header_$ac_safe'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1795 "configure"
+#line 1968 "configure"
 #include "confdefs.h"
 #include <$ac_hdr>
 EOF
 ac_try="$ac_cpp conftest.$ac_ext >/dev/null 2>conftest.out"
-{ (eval echo configure:1800: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
-ac_err=`grep -v '^ *+' conftest.out`
+{ (eval echo configure:1973: \"$ac_try\") 1>&5; (eval $ac_try) 2>&5; }
+ac_err=`grep -v '^ *+' conftest.out | grep -v "^conftest.${ac_ext}\$"`
 if test -z "$ac_err"; then
   rm -rf conftest*
   eval "ac_cv_header_$ac_safe=yes"
@@ -1825,12 +1998,12 @@
 for ac_func in getpagesize
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:1829: checking for $ac_func" >&5
+echo "configure:2002: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 1834 "configure"
+#line 2007 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -1853,7 +2026,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:1857: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2030: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -1878,7 +2051,7 @@
 done
 
 echo $ac_n "checking for working mmap""... $ac_c" 1>&6
-echo "configure:1882: checking for working mmap" >&5
+echo "configure:2055: checking for working mmap" >&5
 if eval "test \"`echo '$''{'ac_cv_func_mmap_fixed_mapped'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -1886,7 +2059,7 @@
   ac_cv_func_mmap_fixed_mapped=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 1890 "configure"
+#line 2063 "configure"
 #include "confdefs.h"
 
 /* Thanks to Mike Haertel and Jim Avera for this test.
@@ -2026,7 +2199,7 @@
 }
 
 EOF
-if { (eval echo configure:2030: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2203: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null
 then
   ac_cv_func_mmap_fixed_mapped=yes
 else
@@ -2049,12 +2222,12 @@
 fi
 
 echo $ac_n "checking return type of signal handlers""... $ac_c" 1>&6
-echo "configure:2053: checking return type of signal handlers" >&5
+echo "configure:2226: checking return type of signal handlers" >&5
 if eval "test \"`echo '$''{'ac_cv_type_signal'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2058 "configure"
+#line 2231 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <signal.h>
@@ -2071,7 +2244,7 @@
 int i;
 ; return 0; }
 EOF
-if { (eval echo configure:2075: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:2248: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   ac_cv_type_signal=void
 else
@@ -2099,7 +2272,7 @@
 fi
 
 echo $ac_n "checking for wait3 that fills in rusage""... $ac_c" 1>&6
-echo "configure:2103: checking for wait3 that fills in rusage" >&5
+echo "configure:2276: checking for wait3 that fills in rusage" >&5
 if eval "test \"`echo '$''{'ac_cv_func_wait3_rusage'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -2107,7 +2280,7 @@
   ac_cv_func_wait3_rusage=no
 else
   cat > conftest.$ac_ext <<EOF
-#line 2111 "configure"
+#line 2284 "configure"
 #include "confdefs.h"
 #include <sys/types.h>
 #include <sys/time.h>
@@ -2138,7 +2311,7 @@
   }
 }
 EOF
-if { (eval echo configure:2142: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2315: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null
 then
   ac_cv_func_wait3_rusage=yes
 else
@@ -2164,12 +2337,12 @@
 sysconf setsid sigsetjmp
 do
 echo $ac_n "checking for $ac_func""... $ac_c" 1>&6
-echo "configure:2168: checking for $ac_func" >&5
+echo "configure:2341: checking for $ac_func" >&5
 if eval "test \"`echo '$''{'ac_cv_func_$ac_func'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2173 "configure"
+#line 2346 "configure"
 #include "confdefs.h"
 /* System header to define __stub macros and hopefully few prototypes,
     which can conflict with char $ac_func(); below.  */
@@ -2192,7 +2365,7 @@
 
 ; return 0; }
 EOF
-if { (eval echo configure:2196: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest; then
+if { (eval echo configure:2369: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext}; then
   rm -rf conftest*
   eval "ac_cv_func_$ac_func=yes"
 else
@@ -2218,7 +2391,7 @@
 
 
 echo $ac_n "checking for an abused getenv""... $ac_c" 1>&6
-echo "configure:2222: checking for an abused getenv" >&5
+echo "configure:2395: checking for an abused getenv" >&5
 if eval "test \"`echo '$''{'es_cv_abused_getenv'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
@@ -2226,7 +2399,7 @@
     { echo "configure: error: can not run test program while cross compiling" 1>&2; exit 1; }
 else
   cat > conftest.$ac_ext <<EOF
-#line 2230 "configure"
+#line 2403 "configure"
 #include "confdefs.h"
 
 
@@ -2239,7 +2412,7 @@
 
 
 EOF
-if { (eval echo configure:2243: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest && (./conftest; exit) 2>/dev/null
+if { (eval echo configure:2416: \"$ac_link\") 1>&5; (eval $ac_link) 2>&5; } && test -s conftest${ac_exeext} && (./conftest; exit) 2>/dev/null
 then
   es_cv_abused_getenv=no
 else
@@ -2265,12 +2438,12 @@
 fi
 
 echo $ac_n "checking whether assignment to va_list ok?""... $ac_c" 1>&6
-echo "configure:2269: checking whether assignment to va_list ok?" >&5
+echo "configure:2442: checking whether assignment to va_list ok?" >&5
 if eval "test \"`echo '$''{'es_cv_assign_va_list'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2274 "configure"
+#line 2447 "configure"
 #include "confdefs.h"
 #ifndef HAVE_STDARG_H
 choke me
@@ -2281,7 +2454,7 @@
 va_list first, second; first = second; return 0;
 ; return 0; }
 EOF
-if { (eval echo configure:2285: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
+if { (eval echo configure:2458: \"$ac_compile\") 1>&5; (eval $ac_compile) 2>&5; }; then
   rm -rf conftest*
   es_cv_assign_va_list=yes
 else
@@ -2303,12 +2476,12 @@
 fi
 
 echo $ac_n "checking for rlimit type ...""... $ac_c" 1>&6
-echo "configure:2307: checking for rlimit type ..." >&5
+echo "configure:2480: checking for rlimit type ..." >&5
 if eval "test \"`echo '$''{'es_cv_rlimit_t'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2312 "configure"
+#line 2485 "configure"
 #include "confdefs.h"
 #ifdef HAVE_SETRLIMIT
 # include <sys/resource.h>
@@ -2322,12 +2495,12 @@
 echo "$ac_t""$es_cv_rlimit_t" 1>&6
 
 echo $ac_n "checking for files to extract signal information from""... $ac_c" 1>&6
-echo "configure:2326: checking for files to extract signal information from" >&5
+echo "configure:2499: checking for files to extract signal information from" >&5
 if eval "test \"`echo '$''{'SIGFILES'+set}'`\" = set"; then
   echo $ac_n "(cached) $ac_c" 1>&6
 else
   cat > conftest.$ac_ext <<EOF
-#line 2331 "configure"
+#line 2504 "configure"
 #include "confdefs.h"
 #include <signal.h>
 EOF
@@ -2371,7 +2544,7 @@
 # Ultrix sh set writes to stderr and can't be redirected directly,
 # and sets the high bit in the cache file unless we assign to the vars.
 (set) 2>&1 |
-  case `(ac_space=' '; set) 2>&1` in
+  case `(ac_space=' '; set | grep ac_space) 2>&1` in
   *ac_space=\ *)
     # `set' does not quote correctly, so add quotes (double-quote substitution
     # turns \\\\ into \\, and sed turns \\ into \).
@@ -2438,7 +2611,7 @@
     echo "running \${CONFIG_SHELL-/bin/sh} $0 $ac_configure_args --no-create --no-recursion"
     exec \${CONFIG_SHELL-/bin/sh} $0 $ac_configure_args --no-create --no-recursion ;;
   -version | --version | --versio | --versi | --vers | --ver | --ve | --v)
-    echo "$CONFIG_STATUS generated by autoconf version 2.12"
+    echo "$CONFIG_STATUS generated by autoconf version 2.13"
     exit 0 ;;
   -help | --help | --hel | --he | --h)
     echo "\$ac_cs_usage"; exit 0 ;;
@@ -2458,9 +2631,11 @@
  s/@@/%@/; s/@@/@%/; s/@g\$/%g/' > conftest.subs <<\\CEOF
 $ac_vpsub
 $extrasub
+s%@SHELL@%$SHELL%g
 s%@CFLAGS@%$CFLAGS%g
 s%@CPPFLAGS@%$CPPFLAGS%g
 s%@CXXFLAGS@%$CXXFLAGS%g
+s%@FFLAGS@%$FFLAGS%g
 s%@DEFS@%$DEFS%g
 s%@LDFLAGS@%$LDFLAGS%g
 s%@LIBS@%$LIBS%g
@@ -2486,6 +2661,7 @@
 s%@host_os@%$host_os%g
 s%@CC@%$CC%g
 s%@INSTALL_PROGRAM@%$INSTALL_PROGRAM%g
+s%@INSTALL_SCRIPT@%$INSTALL_SCRIPT%g
 s%@INSTALL_DATA@%$INSTALL_DATA%g
 s%@YACC@%$YACC%g
 s%@CPP@%$CPP%g
diff -u es-0.9-beta1/configure.in es-0.9-job-alpha2/configure.in
--- es-0.9-beta1/configure.in	1997-08-13 12:34:58.000000000 -0600
+++ es-0.9-job-alpha2/configure.in	2006-11-27 10:08:16.000000000 -0600
@@ -13,12 +13,11 @@
 rm -f conftest*
 ])
 
-
-use_readline=no
+use_readline=yes
 use_editline=no
-
+	
 AC_ARG_WITH(readline,
---with-readline		Use GNU Readline, use_readline=yes)
+--without-readline		Use GNU Readline, use_readline=no)
 AC_ARG_WITH(editline,
 --with-editline		Use the Editline library, use_editline=yes)
 
@@ -61,8 +60,12 @@
 
 if test "$use_readline" = yes || test "$use_editline" = yes
 then
-	AC_CHECK_LIB(terminfo, main)
-	AC_CHECK_LIB(termcap, main)
+	AC_CHECK_LIB(ncurses, main,,
+        	AC_CHECK_LIB(curses, main,,
+		 	AC_CHECK_LIB(terminfo, main)
+ 			AC_CHECK_LIB(termcap, main)
+		)
+	)
 	if test "$use_readline" = yes
 	then
 		AC_CHECK_LIB(readline, readline)
Only in es-0.9-beta1: conv.o
Only in es-0.9-beta1: dict.o
Only in es-0.9-beta1: dump.o
Only in es-0.9-beta1: es
Only in es-0.9-job-alpha2/: es-mode.el
diff -u es-0.9-beta1/es.h es-0.9-job-alpha2/es.h
--- es-0.9-beta1/es.h	1997-08-12 17:59:20.000000000 -0600
+++ es-0.9-job-alpha2/es.h	2002-04-16 18:51:46.000000000 -0600
@@ -219,9 +219,15 @@
 
 
 /* proc.c */
-
 extern Boolean hasforked;
-extern int efork(Boolean parent, Boolean background);
+extern int assign_tty(int tty, int pgid);
+extern int has_job_control;
+extern int shell_tty;
+extern int shell_pgid;
+extern struct termios shell_tmodes;
+
+extern void chldwait(void);
+extern int efork(Boolean parent, Boolean background, int pgid, List *cmd);
 extern int ewait(int pid, Boolean interruptible, void *rusage);
 #define	ewaitfor(pid)	ewait(pid, FALSE, NULL)
 
@@ -346,6 +352,8 @@
 extern void setsigdefaults(void);
 extern void blocksignals(void);
 extern void unblocksignals(void);
+extern void block(int);
+extern void unblock(int);
 
 
 /* open.c */
Only in es-0.9-job-alpha2/: es.txt
Only in es-0.9-beta1: esdump
diff -u es-0.9-beta1/eval.c es-0.9-job-alpha2/eval.c
--- es-0.9-beta1/eval.c	1997-08-12 17:59:21.000000000 -0600
+++ es-0.9-job-alpha2/eval.c	2002-04-16 18:53:26.000000000 -0600
@@ -1,6 +1,7 @@
 /* eval.c -- evaluation of lists and trees ($Revision: 1.2 $) */
 
 #include "es.h"
+#include "term.h"
 
 unsigned long evaldepth = 0, maxevaldepth = MAXmaxevaldepth;
 
@@ -28,20 +29,20 @@
 	Vector *env;
 	gcdisable();
 	env = mkenv();
-	pid = efork(!inchild, FALSE);
+	pid = efork(!inchild, FALSE, 0, list);
 	if (pid == 0) {
 		execve(file, vectorize(list)->vector, env->vector);
 		failexec(file, list);
 	}
 	gcenable();
 	status = ewaitfor(pid);
-	if ((status & 0xff) == 0) {
+	if (SIFSIGNALED(status)) {
 		sigint_newline = FALSE;
 		SIGCHK();
 		sigint_newline = TRUE;
 	} else
 		SIGCHK();
-	printstatus(0, status);
+	printstatus(pid, status);
 	return mklist(mkterm(mkstatus(status), NULL), NULL);
 }
 
Only in es-0.9-beta1: eval.o
Only in es-0.9-beta1: except.o
Only in es-0.9-beta1: fd.o
Only in es-0.9-beta1: gc.o
Only in es-0.9-beta1: glob.o
Only in es-0.9-beta1: glom.o
Only in es-0.9-beta1: heredoc.o
Only in es-0.9-beta1: initial.c
diff -u es-0.9-beta1/initial.es es-0.9-job-alpha2/initial.es
--- es-0.9-beta1/initial.es	1997-04-11 14:54:33.000000000 -0600
+++ es-0.9-job-alpha2/initial.es	2006-11-27 10:07:41.000000000 -0600
@@ -80,6 +80,7 @@
 
 fn-%read	= $&read
 
+
 #	eval runs its arguments by turning them into a code fragment
 #	(in string form) and running that fragment.
 
@@ -754,3 +755,234 @@
 #	wants to look at initial.c anyway.
 
 result es initial state built in `/bin/pwd on `/bin/date for <=$&version
+
+####################################################################
+#                           job control                            #
+####################################################################
+
+
+########### convenience frontends to intenal functions #############
+
+# Remembers the last used job pid.
+apid = -1
+
+# Syntax:      %jobs
+# Description: Return a list of background child job pids.
+fn %jobs {$&apids -j}
+
+# Syntax:      jobs
+# Description: Print information on background jobs.
+fn jobs {
+    for (j = <=%jobs) {
+        if {~ $#j 0} {break} 
+        let (info = <={$&procinfo $j}) {
+            echo $j ^ \t ^ $info(7)
+        }
+    }
+}
+
+# Syntax:      jobtopid [pid | %n | substring]
+# Description: Return the pid of the background job which matches the given
+#              argument or fail otherwise. The argument can be a pid, a job
+#              number (as shown by jobs) or a substring of the command string
+#              of the job. If more than one job matches, only the pid of the
+#              first one (sorted by execution time) is returned.
+fn jobtopid arg { 
+    if {~ $#arg 0} {
+        if {!~ $apid <=%jobs} {
+            let (j = <=%jobs) {
+                if {~ $#j 0} { return } { return $j($#j) }
+            }
+        } {
+            return $apid 
+        }
+    } {~ $#arg 1} {
+	if {~ $arg <=%jobs} {
+	    return $arg
+	}
+        let (pid =; cmd =; info =) {
+            for (j = <={$&apids -j}) {
+                info = <={$&procinfo $j}
+		pid = $info(1)
+		cmd = $info(7)
+                if {eval '~' \'$cmd\' '*'^$arg^'*'} {
+                    return $pid
+                }
+	    }
+	    # no match found:
+            throw error jobtopid $arg 'is not a valid [pid | substring]'
+	}
+    } {
+        throw error jobtopid 'argument must be empty or [pid \| substring]'
+    }
+}
+
+# Syntax:      %jobargs [arg1 [arg2 [... argn]]]
+# Description: Transforms its argument list to a list of pids using jobtopid.
+#              Any argi which cannot be transformed to a job pid is retained
+#              verbatim in the list.
+fn %jobargs args {
+    let (newargs = ) {
+        for (arg = $args) {
+            newargs=$newargs <={
+                catch @ e ty msg {
+	            result $arg
+	        } {
+	            jobtopid $arg
+	        }
+	    }
+	}
+        return $newargs
+    }
+}
+    
+# Syntax:      kill [options] pid1 [pid2 [... pidn]]
+# Description: A wrapper to the systems kill command which understands jobs.
+fn kill args {
+    <={%pathsearch kill} <={%jobargs $args}
+}
+
+# Syntax:      nice [options] pid1 [pid2 [... pidn]]
+# Description: A wrapper to the systems nice command which understands jobs.
+fn nice args {
+    <={%pathsearch kill} <={%jobargs $args}
+}
+
+# Syntax:      fg [pid]
+# Description: Put pid or $apid into the forground and update $apid.
+fn fg arg {
+  apid = <={jobtopid $arg} 
+  if {~ $#apid 1} {$&fg $apid}
+}
+
+# Syntax:      bg [pid]
+# Description: Put pid or $apid into the background and update $apid.
+fn bg arg {
+  apid = <={jobtopid $arg}
+  if {~ $#apid 1} {$&bg $apid}
+}
+
+# Syntax:      apids [-j | -a]
+# Description: Print a list of child process. If the -j option is given, then 
+#              only the first member of each job will be reported. If -a is
+#              given, then all known childs, even dead ones will be reported.
+#              Under normal operation dead childs are removed automatically
+#              from the list of known processes whenever %interactive-loop
+#              asks for a new line of input. For a non-interactive shell this
+#              removal takes place, whenever th shell waits for the completion
+#              of an executable. It is save to remove dead processes with a
+#              call to $&procfree.
+fn apids arg {echo <={$&apids $args}}
+
+# Syntax:      procinfo [[pid | %n | substring] ...]
+# Description: Print a list with detailed information on the given processes.
+#              The list consists of the following eight entries:
+#
+#    index:     1   2     3       4         5        6       7      8
+#    type:     int int   bool    bool      bool     bool   string  int
+#    name:     pid pgid alive background stopped haschanged cmd   status,
+#
+#              where pid, pgid, alive, background, stopped and cmd have
+#              obvious meanings. haschanged gets set to true when the process
+#              dies, stops or goes into the background. It is reset to false 
+#              from the %interactive-loop. status is the returned status of
+#              the last call to the internal wait subroutine for this pid. If
+#              the process has not been waited for, status' value is
+#              unspecified.
+fn procinfo args { 
+    if {~ $#apid 1 && ~ $#args 0} {
+        echo <={$&procinfo <=jobtopid}
+    } {
+        for (pid = $args) {
+            echo <={$&procinfo <={jobtopid $pid}}
+	}
+    }
+}
+
+# Syntax:      procchange pid
+# Description: Toggel the haschanged status of a process. Used internally.
+# fn-procchange = $&procchange
+
+# Syntax:      procfree pid
+# Description: Free a process from the process list and return the allocated 
+#              memory to the malloc pool. You can shoot in your own foot, if
+#              you remove processes which are still alive -- be aware of zombies!
+#              Don't use unless you know what you are doing.
+# fn-procfree = $&procfree
+
+
+
+
+####################### job control aware REPL #########################
+
+# Syntax:      checkprocs
+# Description: Check for termination, stopping and backgrounding of processes
+#              and take appropriate actions upon: Print and update status
+#              information and free memory of died processes.
+fn checkprocs {
+    for (pid = <={$&apids -a}) {
+        let ((pid pgid alive backgnd stopped change cmd stat) = <={$&procinfo $pid}) {
+            if {!$alive && $backgnd} {
+	        $&procfree $pid 
+	        echo >[1=2] $pid terminated with $stat^:\t$cmd
+            } {!$alive} {
+	        $&procfree $pid
+	    } {$stopped && $change} {
+	        $&procchange $pid
+	        echo >[1=2] $pid stopped:\t$cmd
+	    }
+	}
+    }
+}
+
+# Syntx:        %interactive-loop
+# Description:  This incarnation of %interactive-loop adds only checkprocs in
+#               front of the prompting to the default %interactive-loop provided
+#               by initial.es. See therein for further documentation.
+fn %interactive-loop {
+	let (result = <=true; %exit2 = true) {
+		catch @ e type msg {
+			if {~ $e eof} {
+	                        echo >[1=2] EOF: Exiting ...
+                        	return $result
+                        } {~ $e exit} {
+                                if {$%exit2} {
+		                        echo >[1=2] Exiting ...
+                                        throw $e $type $msg
+                                }
+                                echo >[1=2] You have background jobs.
+                                %exit2 = true
+			} {~ $e error} {
+				echo >[1=2] $msg
+				$fn-%dispatch false
+			} {~ $e signal} {
+	                        if {~ $type sigtstp} {
+                                	# fixme: delete: echo >[1=2] interrupted by sigtstp
+                                } {~ $type sigint sigterm sigquit} {
+                                	# noop
+                                } {
+					echo >[1=2] caught unexpected signal: $type
+				}
+			} {
+				echo >[1=2] uncaught exception: $e $type $msg
+			}
+			throw retry # restart forever loop
+		} {
+			forever {
+				checkprocs
+				if {!~ $#fn-%prompt 0} {
+					%prompt
+				}
+				let (code = <={%parse $prompt}) {
+					if {!~ $#code 0} {
+						result = <={$fn-%dispatch $code}
+                                                $&donotwait
+                                                if {$&apids} {%exit2 = true} {%exit2 = false}
+					} {
+                                        	$&donotwait
+                                        }
+				}
+                        }
+		}
+	}
+}
Only in es-0.9-beta1: initial.o
diff -u es-0.9-beta1/input.c es-0.9-job-alpha2/input.c
--- es-0.9-beta1/input.c	1997-08-12 17:59:26.000000000 -0600
+++ es-0.9-job-alpha2/input.c	2002-04-24 18:14:24.000000000 -0600
@@ -29,15 +29,18 @@
 Boolean disablehistory = FALSE;
 Boolean resetterminal = FALSE;
 static char *history;
-static int historyfd = -1;
+static int historyfd = -1; //fixme: outcomment for gnureadline
 
 #if READLINE
 int rl_meta_chars;	/* for editline; ignored for gnu readline */
 extern char *readline(char *);
 extern void add_history(char *);
+/* extern void clear_history(void); */
+extern char *rl_readline_name;
 extern void rl_reset_terminal(char *);
 extern char *rl_basic_word_break_characters;
 extern char *rl_completer_quote_characters;
+void readhistory(char* file);
 
 #if ABUSED_GETENV
 static char *stdgetenv(const char *);
@@ -82,7 +85,7 @@
  */
 
 /* loghistory -- write the last command out to a file */
-static void loghistory(const char *cmd, size_t len) {
+static void loghistory(const char *cmd, size_t len) { //fixme: outcomment for gnureadline
 	const char *s, *end;
 	if (history == NULL || disablehistory)
 		return;
@@ -113,11 +116,15 @@
 
 /* sethistory -- change the file for the history log */
 extern void sethistory(char *file) {
+	history = file;
+#if HAVE_LIBREADLINE
+        read_history(file);
+#else
 	if (historyfd != -1) {
 		close(historyfd);
 		historyfd = -1;
 	}
-	history = file;
+#endif
 }
 
 
@@ -273,7 +280,7 @@
 }
 
 char *
-getenv(char *name)
+getenv(const char *name) 
 {
 	return realgetenv(name);
 }
@@ -288,21 +295,69 @@
 
 #endif	/* READLINE */
 
+/* fixme: delete */
+#if 0
+void readhistory(char* file) {
+#if READLINE
+        int fd;
+	char *line, buf[1024];
+	int lsz, rsz, l;
+	
+	if ((fd = eopen(file, oOpen)) < 0) {
+		return;
+	}
+	
+	line = ealloc(1024);
+	lsz = 1024;
+	
+	line[0] = '\0';
+	l = 0;
+	while ((rsz = read(fd, buf, 1024)) > 0) {
+		char *c = buf;
+		while (rsz-->0) {
+			line[l] = *(c++);
+			if (line[l] == '\n') {
+				line[l] = '\0';
+				add_history(line);
+				line[0] = '\0';
+				l = 0;
+				continue;
+			}
+			if (++l == lsz) { 
+				efree(line);
+				line = erealloc(line, lsz += 1024);
+			}
+		}
+	}
+	line[l] = '\0';
+	if (line[0] != '\0') {
+		add_history(line);
+	}
+	efree(line);
+	close(fd);
+#endif
+        return;
+}
+#endif 
+
 /* fdfill -- fill input buffer by reading from a file descriptor */
 static int fdfill(Input *in) {
 	long nread;
+#if READLINE
+	static char *lastinbuf = NULL;
+   	Boolean dolog;
+#endif
 	assert(in->buf == in->bufend);
 	assert(in->fd >= 0);
 
 #if READLINE
 	if (in->runflags & run_interactive && in->fd == 0) {
 		char *rlinebuf = callreadline(prompt);
+	   	dolog = FALSE;
 		if (rlinebuf == NULL)
 
 			nread = 0;
 		else {
-			if (*rlinebuf != '\0')
-				add_history(rlinebuf);
 			nread = strlen(rlinebuf) + 1;
 			if (in->buflen < nread) {
 				while (in->buflen < nread)
@@ -312,6 +367,17 @@
 			}
 			memcpy(in->bufbegin, rlinebuf, nread - 1);
 			in->bufbegin[nread - 1] = '\n';
+			dolog = *rlinebuf != '\0' && 
+                        	(lastinbuf == NULL || strcmp(rlinebuf, lastinbuf));
+#if HAVE_LIBREADLINE
+			free(lastinbuf); /* fixme: is rlinebuf reused by editline? */
+#else
+			dolog = TRUE;
+#endif
+			if (dolog) {
+				add_history(rlinebuf);
+			}
+			lastinbuf = rlinebuf;
 		}
 	} else
 #endif
@@ -330,8 +396,15 @@
 		return EOF;
 	}
 
-	if (in->runflags & run_interactive)
+	if (in->runflags & run_interactive) {
+#if READLINE
+                if (dolog) {
+                        append_history(1, history);
+                }
+#else
 		loghistory((char *) in->bufbegin, nread);
+#endif       
+        }
 
 	in->buf = in->bufbegin;
 	in->bufend = &in->buf[nread];
@@ -584,14 +657,16 @@
 	globalroot(&prompt2);		/* secondary prompt */
 
 	/* mark the historyfd as a file descriptor to hold back from forked children */
-	registerfd(&historyfd, TRUE);
+	registerfd(&historyfd, TRUE); // fixme: delete for gnureadline
 
 	/* call the parser's initialization */
 	initparse();
 
 #if READLINE
 	rl_meta_chars = 0;
+	rl_readline_name = "es";
 	rl_basic_word_break_characters=" \t\n\\'`$><=;|&{()}";
-		rl_completer_quote_characters="'";
+        rl_completer_quote_characters="'";
+        using_history();
 #endif
 }
Only in es-0.9-beta1: input.o
Only in es-0.9-job-alpha2/: job.c
Only in es-0.9-beta1: list.o
diff -u es-0.9-beta1/main.c es-0.9-job-alpha2/main.c
--- es-0.9-beta1/main.c	1997-08-12 17:59:28.000000000 -0600
+++ es-0.9-job-alpha2/main.c	2002-04-10 18:00:01.000000000 -0600
@@ -9,6 +9,7 @@
 Boolean gcinfo		= FALSE;	/* -I */
 #endif
 
+
 /* #if 0 && !HPUX && !defined(linux) && !defined(sgi) */
 /* extern int getopt (int argc, char **argv, const char *optstring); */
 /* #endif */
Only in es-0.9-beta1: main.o
Only in es-0.9-beta1: match.o
Only in es-0.9-job-alpha2/: missing
Only in es-0.9-beta1: open.o
Only in es-0.9-beta1: opt.o
diff -u es-0.9-beta1/prim-ctl.c es-0.9-job-alpha2/prim-ctl.c
--- es-0.9-beta1/prim-ctl.c	1997-04-11 14:54:34.000000000 -0600
+++ es-0.9-job-alpha2/prim-ctl.c	2002-04-17 11:50:16.000000000 -0600
@@ -77,8 +77,12 @@
 				if (termeq(fromcatcher->term, "retry")) {
 					retry = TRUE;
 					unblocksignals();
-				} else
+				} else {
+		
+					unblocksignals();
 					throw(fromcatcher);
+				}
+	   
 			EndExceptionHandler
 
 		EndExceptionHandler
Only in es-0.9-beta1: prim-ctl.o
diff -u es-0.9-beta1/prim-etc.c es-0.9-job-alpha2/prim-etc.c
--- es-0.9-beta1/prim-etc.c	1997-08-12 17:59:29.000000000 -0600
+++ es-0.9-job-alpha2/prim-etc.c	2002-04-27 15:44:02.000000000 -0600
@@ -5,6 +5,10 @@
 #include "es.h"
 #include "prim.h"
 
+PRIM(keybind) {
+	return mklist(mkstr(str("%d",rl_parse_and_bind(str("%L",list," ")))),NULL);
+}
+
 PRIM(result) {
 	return list;
 }
@@ -291,6 +295,7 @@
  */
 
 extern Dict *initprims_etc(Dict *primdict) {
+	X(keybind);
 	X(echo);
 	X(count);
 	X(version);
Only in es-0.9-beta1: prim-etc.o
diff -u es-0.9-beta1/prim-io.c es-0.9-job-alpha2/prim-io.c
--- es-0.9-beta1/prim-io.c	1997-08-12 17:59:31.000000000 -0600
+++ es-0.9-job-alpha2/prim-io.c	2002-04-29 11:53:51.000000000 -0600
@@ -3,9 +3,14 @@
 #include "es.h"
 #include "gc.h"
 #include "prim.h"
+#include "term.h"
 
 static const char *caller;
 
+/* This typedef only is needed to promote the pid of the 
+ * here-document-process to PRIM(here): ugly like hell, but works */
+typedef struct {List * l; int pid;} listpid;
+
 static int getnumber(const char *s) {
 	char *end;
 	int result = strtol(s, &end, 0);
@@ -15,16 +20,18 @@
 	return result;
 }
 
-static List *redir(List *(*rop)(int *fd, List *list), List *list, int evalflags) {
+static listpid redir(listpid (*rop)(int *fd, List *list), List *list, int evalflags) {
 	int destfd, srcfd;
+	listpid r;
 	volatile int inparent = (evalflags & eval_inchild) == 0;
 	volatile int ticket = UNREGISTERED;
 
 	assert(list != NULL);
 	Ref(List *, lp, list);
 	destfd = getnumber(getstr(lp->term));
-	lp = (*rop)(&srcfd, lp->next);
-
+	r = (*rop)(&srcfd, lp->next);
+	lp = r.l;
+	  
 	ExceptionHandler
 		ticket = (srcfd == -1)
 			   ? defer_close(inparent, destfd)
@@ -36,16 +43,20 @@
 		throw(e);
 	EndExceptionHandler
 
-	RefReturn(lp);
+	r.l = lp;
+	RefEnd(lp);
+	return r;
 }
 
-#define	REDIR(name)	static List *CONCAT(redir_,name)(int *srcfdp, List *list)
+
+#define	REDIR(name)	static  listpid CONCAT(redir_,name)(int *srcfdp, List *list)
 
 static noreturn argcount(const char *s) {
 	fail(caller, "argument count: usage: %s", s);
 }
 
 REDIR(openfile) {
+	listpid r;
 	int i, fd;
 	char *mode, *name;
 	OpenKind kind;
@@ -82,7 +93,10 @@
 	if (fd == -1)
 		fail("$&openfile", "%s: %s", name, esstrerror(errno));
 	*srcfdp = fd;
-	RefReturn(lp);
+	r.l = lp;
+	r.pid = -1;
+	RefEnd(lp);
+	return r;
 }
 
 PRIM(openfile) {
@@ -94,10 +108,11 @@
 	lp = list->next;
 	list->next = lp->next;
 	lp->next = list;
-	return redir(redir_openfile, lp, evalflags);
+	return redir(redir_openfile, lp, evalflags).l;
 }
 
 REDIR(dup) {
+	listpid r;
 	int fd;
 	assert(length(list) == 2);
 	Ref(List *, lp, list);
@@ -106,32 +121,38 @@
 		fail("$&dup", "dup: %s", esstrerror(errno));
 	*srcfdp = fd;
 	lp = lp->next;
-	RefReturn(lp);
+	r.l = lp;
+	r.pid = -1;
+	RefEnd(lp);
+	return r;
 }
 
 PRIM(dup) {
 	caller = "$&dup";
 	if (length(list) != 3)
 		argcount("%dup newfd oldfd cmd");
-	return redir(redir_dup, list, evalflags);
+	return redir(redir_dup, list, evalflags).l;
 }
 
 REDIR(close) {
+	listpid r;
 	*srcfdp = -1;
-	return list;
+	r.l = list;
+	r.pid = -1;
+	return r;
 }
 
 PRIM(close) {
 	caller = "$&close";
 	if (length(list) != 2)
 		argcount("%close fd cmd");
-	return redir(redir_close, list, evalflags);
+	return redir(redir_close, list, evalflags).l;
 }
 
 /* pipefork -- create a pipe and fork */
-static int pipefork(int p[2], int *extra) {
+static int pipefork(int p[2], int *extra, int pgid, List *cmd) {
 	volatile int pid = 0;
-
+	
 	if (pipe(p) == -1)
 		fail(caller, "pipe: %s", esstrerror(errno));
 
@@ -139,9 +160,9 @@
 	registerfd(&p[1], FALSE);
 	if (extra != NULL)
 		registerfd(extra, FALSE);
-
+	
 	ExceptionHandler
-		pid = efork(TRUE, FALSE);
+	  	pid = efork(TRUE, FALSE, pgid, cmd);
 	CatchExceptionIf (pid != 0, e)
 		unregisterfd(&p[0]);
 		unregisterfd(&p[1]);
@@ -159,6 +180,7 @@
 
 REDIR(here) {
 	int pid, p[2];
+	listpid r;
 	List *doc, *tail, **tailp;
 
 	assert(list != NULL);
@@ -167,7 +189,8 @@
 	doc = (list == tail) ? NULL : list;
 	*tailp = NULL;
 
-	if ((pid = pipefork(p, NULL)) == 0) {		/* child that writes to pipe */
+	if ((pid = pipefork(p, NULL, -1, mklist(mkstr("$&here"),NULL))) == 0) {	
+		/* child that writes to pipe */
 		close(p[0]);
 		fprint(p[1], "%L", doc, "");
 		exit(0);
@@ -175,20 +198,28 @@
 
 	close(p[1]);
 	*srcfdp = p[0];
-	return tail;
+	r.pid = pid;
+	r.l = tail;
+	return r;
 }
 
 PRIM(here) {
+	listpid r;
 	caller = "$&here";
 	if (length(list) < 2)
 		argcount("%here fd [word ...] cmd");
-	return redir(redir_here, list, evalflags);
+        r = redir(redir_here, list, evalflags);
+	if (r.pid > 0) {
+		ewait(r.pid, TRUE, NULL);
+	}
+	return r.l;
 }
 
 PRIM(pipe) {
 	int n, infd, inpipe;
 	static int *pids = NULL, pidmax = 0;
-
+	int pgid=0;
+	
 	caller = "$&pipe";
 	n = length(list);
 	if ((n % 3) != 1)
@@ -205,7 +236,12 @@
 	for (;; list = list->next) {
 		int p[2], pid;
 		
-		pid = (list->next == NULL) ? efork(TRUE, FALSE) : pipefork(p, &inpipe);
+		pid = (list->next == NULL) ?
+			efork(TRUE, FALSE, pgid, mklist(list->term, NULL)) :
+			pipefork(p, &inpipe, pgid, mklist(list->term, NULL));
+		if (has_job_control && pgid==0 && pid!=0) {
+			pgid=pid;
+		}
 
 		if (pid == 0) {		/* child */
 			if (inpipe != -1) {
@@ -259,7 +295,7 @@
 	lp = lp->next;
 	Ref(Term *, cmd, lp->term);
 
-	if ((pid = pipefork(p, NULL)) == 0) {
+	if ((pid = pipefork(p, NULL, 0, mklist(cmd, NULL))) == 0) {
 		close(p[0]);
 		mvfd(p[1], 1);
 		exit(exitstatus(eval1(input, evalflags &~ eval_inchild)));
@@ -300,7 +336,7 @@
 	lp = lp->next;
 	Ref(Term *, cmd, lp->term);
 
-	if ((pid = pipefork(p, NULL)) == 0) {
+	if ((pid = pipefork(p, NULL, 0, mklist(cmd, NULL))) == 0) {
 		close(p[1]);
 		mvfd(p[0], 0);
 		exit(exitstatus(eval1(output, evalflags &~ eval_inchild)));
@@ -326,7 +362,7 @@
 	RefEnd3(cmd, output, var);
 	RefReturn(lp);
 }
-#endif
+#endif /* HAVE_DEV_FD */
 
 #define	BUFSIZE	4096
 
@@ -359,7 +395,7 @@
 	Ref(char *, sep, getstr(lp->term));
 	lp = lp->next;
 
-	if ((pid = pipefork(p, NULL)) == 0) {
+	if ((pid = pipefork(p, NULL, 0, lp)) == 0) {
 		mvfd(p[1], 1);
 		close(p[0]);
 		exit(exitstatus(eval(lp, NULL, evalflags | eval_inchild)));
Only in es-0.9-beta1: prim-io.o
diff -u es-0.9-beta1/prim-sys.c es-0.9-job-alpha2/prim-sys.c
--- es-0.9-beta1/prim-sys.c	1997-08-12 17:59:33.000000000 -0600
+++ es-0.9-job-alpha2/prim-sys.c	2002-04-28 16:09:49.000000000 -0600
@@ -4,6 +4,7 @@
 
 #include "es.h"
 #include "prim.h"
+#include "term.h"
 
 #ifdef HAVE_SETRLIMIT
 # define BSD_LIMITS 1
@@ -12,12 +13,13 @@
 #endif
 
 #if BSD_LIMITS || BUILTIN_TIME
-#include <sys/time.h>
-#include <sys/resource.h>
-#if !HAVE_WAIT3
-#include <sys/times.h>
-#include <limits.h>
-#endif
+# include <time.h>
+# include <sys/time.h>
+# include <sys/resource.h>
+# if !HAVE_WAIT3
+#  include <sys/times.h>
+#  include <limits.h>
+# endif
 #endif
 
 PRIM(newpgrp) {
@@ -41,13 +43,9 @@
 }
 
 PRIM(background) {
-	int pid = efork(TRUE, TRUE);
+	int pid = efork(TRUE, TRUE, 0, list);
+	setpgid(pid, getpid());
 	if (pid == 0) {
-#if JOB_PROTECT
-		/* job control safe version: put it in a new pgroup. */
-		setpgrp(0, getpid());
-#endif
-		mvfd(eopen("/dev/null", oOpen), 0);
 		exit(exitstatus(eval(list, NULL, evalflags | eval_inchild)));
 	}
 	return mklist(mkstr(str("%d", pid)), NULL);
@@ -55,7 +53,7 @@
 
 PRIM(fork) {
 	int pid, status;
-	pid = efork(TRUE, FALSE);
+	pid = efork(TRUE, FALSE, 0, list);
 	if (pid == 0)
 		exit(exitstatus(eval(list, NULL, evalflags | eval_inchild)));
 	status = ewaitfor(pid);
@@ -306,7 +304,7 @@
 
 	gc();	/* do a garbage collection first to ensure reproducible results */
 	t0 = time(NULL);
-	pid = efork(TRUE, FALSE);
+	pid = efork(TRUE, FALSE, 0, lp);
 	if (pid == 0)
 		exit(exitstatus(eval(lp, NULL, evalflags | eval_inchild)));
 	status = ewait(pid, FALSE, &r);
@@ -331,7 +329,7 @@
 	Ref(List *, lp, list);
 
 	gc();	/* do a garbage collection first to ensure reproducible results */
-	pid = efork(TRUE, FALSE);
+	pid = efork(TRUE, FALSE, 0, lp);
 	if (pid == 0) {
 		clock_t t0, t1;
 		struct tms tms;
@@ -341,7 +339,7 @@
 			ticks = CLK_TCK;
 
 		t0 = times(&tms);
-		pid = efork(TRUE, FALSE);
+		pid = efork(TRUE, FALSE, 0, lp);
 		if (pid == 0)
 			exit(exitstatus(eval(lp, NULL, evalflags | eval_inchild)));
 
Only in es-0.9-beta1: prim-sys.o
Only in es-0.9-beta1: prim.o
Only in es-0.9-beta1: print.o
diff -u es-0.9-beta1/proc.c es-0.9-job-alpha2/proc.c
--- es-0.9-beta1/proc.c	1997-08-12 17:59:34.000000000 -0600
+++ es-0.9-job-alpha2/proc.c	2002-04-29 08:40:06.000000000 -0600
@@ -1,6 +1,9 @@
 /* proc.c -- process control system calls ($Revision: 1.2 $) */
 
 #include "es.h"
+#include "term.h"
+#include "prim.h"
+#include <termios.h> //fixme:make conditionally
 
 /* TODO: the rusage code for the time builtin really needs to be cleaned up */
 
@@ -9,24 +12,28 @@
 #include <sys/resource.h>
 #endif
 
+extern void catcher(int); // fixme: put into es.h
+
+
 Boolean hasforked = FALSE;
 
 typedef struct Proc Proc;
 struct Proc {
-	int pid;
-	int status;
-	Boolean alive, background;
 	Proc *next, *prev;
-#if HAVE_WAIT3
-	struct rusage rusage;
-#endif
+	int pid, pgid, status;
+	Boolean alive, background, stopped, haschanged;
+	struct termios tmodes;
+	char *cmd;
 };
-
 static Proc *proclist = NULL;
 
+
+
 /* mkproc -- create a Proc structure */
-extern Proc *mkproc(int pid, Boolean background) {
+static Proc *mkproc(int pid, Boolean background, List *cmd) {
 	Proc *proc;
+	char *s;
+
 	for (proc = proclist; proc != NULL; proc = proc->next)
 		if (proc->pid == pid) {		/* are we recycling pids? */
 			assert(!proc->alive);	/* if false, violates unix semantics */
@@ -36,28 +43,98 @@
 		proc = ealloc(sizeof (Proc));
 		proc->next = proclist;
 	}
+	proc->prev = NULL;
 	proc->pid = pid;
+	proc->pgid = shell_pgid;
 	proc->alive = TRUE;
 	proc->background = background;
-	proc->prev = NULL;
+	proc->stopped = FALSE;
+	proc->haschanged = FALSE;
+	proc->tmodes = shell_tmodes;
+	
+	s = (cmd==NULL)?"":str("%L",cmd," ");
+	proc->cmd = ealloc(strlen(s)+1);
+	strcpy(proc->cmd, s);
+
 	return proc;
 }
 
-/* efork -- fork (if necessary) and clean up as appropriate */
-extern int efork(Boolean parent, Boolean background) {
+/* Unlink a process from proclist and free up its memory.
+ * A copy of (struct Proc) is kept for further reference and
+ * *p instructed to point thereon. This copy remains valid until
+ * the next call to unlinkproc. */
+static void unlinkproc(Proc **p) {
+	static Proc unlinkedproc;
+	Proc *proc;
+	proc = *p;
+	
+	if (proc==NULL) {
+		return;
+	}
+
+	unlinkedproc = *proc;
+	if (proc->next != NULL) {
+		proc->next->prev = proc->prev;
+	}
+	if (proc->prev != NULL) {
+		proc->prev->next = proc->next;
+	} else {
+		proclist = proc->next;
+	}
+	efree(proc->cmd);
+	efree(proc);
+	*p=&unlinkedproc;
+}
+
+/* POSIX stupidity work-around */
+/* fixme: newpgrp(pid) does almost the same */
+extern int assign_tty(int tty, int pgid) {
+	int r;
+
+	block(SIGTTOU);
+	r=tcsetpgrp(tty, pgid);
+	unblock(SIGTTOU);
+	return r;
+}
+
+/* pgid=0: pgid:=childpid;     pgid=-1: don't change pg */
+extern int efork(Boolean parent, Boolean background, int pgid, List *cmd) {
+	if (pgid==-1) {
+		pgid=shell_pgid;
+	}
 	if (parent) {
 		int pid = fork();
 		switch (pid) {
 		default: {	/* parent */
-			Proc *proc = mkproc(pid, background);
+			Proc *proc;
+			proc = mkproc(pid, background, cmd);
+			if (has_job_control && isinteractive()) {
+				if (pgid==0) {
+					pgid=pid;
+				}
+				
+				setpgid(pid, pgid);
+				proc->pgid=pgid;
+				if (!background) {
+					assign_tty(shell_tty, pgid);
+				}
+			}
 			if (proclist != NULL)
 				proclist->prev = proc;
 			proclist = proc;
 			return pid;
 		}
 		case 0:		/* child */
-			proclist = NULL;
 			hasforked = TRUE;
+			if (has_job_control && isinteractive()) {
+				if (pgid==0) {
+					pgid=getpid();
+				}
+				setpgid(pid, pgid);
+				if (!background && isatty(shell_tty)) {
+					while (assign_tty(shell_tty, pgid)!=0);
+				}
+			}
 			break;
 		case -1:
 			fail("es:efork", "fork: %s", esstrerror(errno));
@@ -68,25 +145,26 @@
 	newchildcatcher();
 	return 0;
 }
+	  
 
-#if HAVE_WAIT3
-static struct rusage wait_rusage;
-#endif
 
+/* fixme: delete?
+ * We don't need a wrapper for sigint and sigtstp anymore, since those signals
+ * are directly received by our childs. But what about other signals?
 /* dowait -- a wait wrapper that interfaces with signals */
-static int dowait(int *statusp) {
+static int waitpidwrapper(int pid, int *statusp, int options) {
 	int n;
 	interrupted = FALSE;
 	if (!setjmp(slowlabel)) {
 		slow = TRUE;
-		n = interrupted ? -2 :
-#if HAVE_WAIT3
-			wait3((void *) statusp, 0, &wait_rusage);
-#else
-			wait((void *) statusp);
-#endif
-	} else
+		if (interrupted) {
+			n = -2;
+		} else {
+			n = waitpid(pid, statusp, options);
+		}
+	} else {
 		n = -2;
+	}
 	slow = FALSE;
 	if (n == -2) {
 		errno = EINTR;
@@ -95,99 +173,158 @@
 	return n;
 }
 
-/* reap -- mark a process as dead and attach its exit status */
-static void reap(int pid, int status) {
+/* Return the first proc which matches the parameters, or otherwise return NULL.
+ * If onlyfg is TRUE then *only* forground can processes match. The first process
+ * of the process group -pid is returned if pid is negative. A zero pid matches 
+ * any process. */
+static Proc *getproc(int pid, Boolean onlyfg) {
 	Proc *proc;
-	for (proc = proclist; proc != NULL; proc = proc->next)
-		if (proc->pid == pid) {
-			assert(proc->alive);
-			proc->alive = FALSE;
-			proc->status = status;
-#if HAVE_WAIT3
-			proc->rusage = wait_rusage;
-#endif
-			return;
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if ((pid == proc->pid || -pid == proc->pgid || pid == 0) &&
+		    proc->alive && 
+		    (!proc->background || !onlyfg) ) {
+		  return proc;
 		}
+	}
+	return NULL;
 }
 
-/* ewait -- wait for a specific process to die, or any process if pid == 0 */
-extern int ewait(int pid, Boolean interruptible, void *rusage) {
+/* Give the tty to the shell if appropriate */
+extern void ask_for_tty(void) {
+	if (isinteractive() && getproc(0, TRUE) == NULL) {
+		assign_tty(shell_tty, shell_pgid);
+		tcsetattr(shell_tty, TCSADRAIN, &shell_tmodes);
+	}
+}
+
+/* Remove all dead processes from the proclist. */
+static void cleanproclist() {
 	Proc *proc;
-top:
-	for (proc = proclist; proc != NULL; proc = proc->next)
-		if (proc->pid == pid || (pid == 0 && !proc->alive)) {
-			int status;
-			if (proc->alive) {
-				int deadpid;
-				while ((deadpid = dowait(&proc->status)) != pid)
-					if (deadpid != -1)
-						reap(deadpid, proc->status);
-					else if (errno != EINTR)
-						fail("es:ewait", "wait: %s", esstrerror(errno));
-					else if (interruptible)
-						SIGCHK();
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if (!proc->alive) {
+			unlinkproc(&proc);
+		}
+	}
+}
+
+/* Wait for background processes without actually waiting for them :-) */
+static int donotwait(void) {
+	Proc *proc;
+	int wpid, wstatus, r = FALSE;
+	
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if ((proc->alive && proc->background)) {
+			wpid = waitpidwrapper(proc->pid, &wstatus, WNOHANG);
+			if (wpid == proc->pid) {
+				proc->haschanged = TRUE;
 				proc->alive = FALSE;
-#if HAVE_WAIT3
-				proc->rusage = wait_rusage;
-#endif
+				proc ->status = wstatus;
+				r = TRUE;
 			}
-			if (proc->next != NULL)
-				proc->next->prev = proc->prev;
-			if (proc->prev != NULL)
-				proc->prev->next = proc->next;
-			else
-				proclist = proc->next;
-			status = proc->status;
-			if (proc->background)
-				printstatus(proc->pid, status);
-			efree(proc);
-#if HAVE_WAIT3
-			if (rusage != NULL)
-				memcpy(rusage, &proc->rusage, sizeof (struct rusage));
-#else
-			assert(rusage == NULL);
-#endif
-			return status;
-		}
-	if (pid == 0) {
-		int status;
-		while ((pid = dowait(&status)) == -1) {
-			if (errno != EINTR)
-				fail("es:ewait", "wait: %s", esstrerror(errno));
-			if (interruptible)
-				SIGCHK();
-		}
-		reap(pid, status);
-		goto top;
+		}                       
 	}
-	fail("es:ewait", "wait: %d is not a child of this shell", pid);
-	NOTREACHED;
+	return r;
 }
 
-#include "prim.h"
 
+/* fixme: delete */
+static void eprintprocs(void) {
+        Proc *proc;
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+                eprint("pid=%5d pgid=%5d al=%d bg=%d tstp=%d chg=%d %s\n",
+                       proc->pid, proc->pgid,
+                       proc->alive, proc->background, proc->stopped,
+                       proc->haschanged, 
+                       proc->cmd);
+        }
+}
+
+/* Wait for a specific process (pid>0), for any process (pid==0) or
+ * for a process group (pid<0). */
+extern int ewait(int pid, Boolean interruptible, void *rusage) {
+	Proc *proc;
+	int wpid, wstatus;
+
+	/* First, kick zombies to hell :-) */
+	donotwait();
+	
+	while (getproc(pid, FALSE) != NULL) {
+		wpid = waitpidwrapper(pid, &wstatus, WUNTRACED); /* fixme: dont use the wrapper */
+		if (wpid == -1) {
+                        /* this is more save than ask_for_tty(); */
+                        assign_tty(shell_tty, shell_pgid);
+                        fail("es:ewait", "wait: %d %s", pid, esstrerror(errno));
+		} else {
+                        proc = getproc(wpid, FALSE);
+			proc->haschanged = TRUE;
+			if (SIFSTOPPED(wstatus)) {
+                                catcher(WSTOPSIG(wstatus));
+				proc->stopped = TRUE;
+				proc->background = TRUE;
+				tcgetattr(shell_tty, &proc->tmodes);
+				break;
+			} else {
+                                if (SIFSIGNALED(wstatus)) {
+                                        catcher(WTERMSIG(wstatus));
+                                }
+				proc->alive = FALSE;
+				proc->status = wstatus;				
+                        }
+		}
+        }
+                
+	/* Dead processes are kept in the proclist of an interactive session until
+	 * explicit deletion. This is done from the REPL before prompting. Large
+	 * interactive jobs must do this themselves to prevent the proclist from 
+	 * increasing to infinity. For non interactive sessions there is no need 
+	 * to keep dead processes for further reference in the proclist. They are
+	 * deleted now: */
+	if (!isinteractive()) {
+		cleanproclist();
+	}
+        
+	ask_for_tty();
+        assign_tty(shell_tty, shell_pgid); //fixme:delete
+	
+	/* we return with the status of the *last* command of a job */
+	return wstatus;
+}		
+		
+	
+	
+
+/* Reports all alive process pids, or the pid of the first alive process of
+ * each job (option -j), or the pids of all jobs in the process list 
+ * (option -a). */
 PRIM(apids) {
 	Proc *p;
+	Boolean jobflag, allflag;
+	int pgid = -1;
+
 	Ref(List *, lp, NULL);
-	for (p = proclist; p != NULL; p = p->next)
-		if (p->background && p->alive) {
-			Term *t = mkstr(str("%d", p->pid));
-			lp = mklist(t, lp);
+		jobflag = (list != NULL && termeq(list->term, "-j"));
+		allflag = (list != NULL && termeq(list->term, "-a"));
+	
+		for (p = proclist; p != NULL; p = p->next) {
+			if (allflag || (p->alive && p->background)) {
+				if (!jobflag || p->pgid != pgid) {
+					Term *t = mkstr(str("%d", p->pid));
+					lp = mklist(t, lp);
+					pgid=p->pgid;
+				}
+			}
 		}
 	/* TODO: sort the return value, but by number? */
+	/*       ..., better by time of creation ;-) */
 	RefReturn(lp);
 }
-
+	  
 PRIM(wait) {
 	int pid;
 	if (list == NULL)
 		pid = 0;
 	else if (list->next == NULL) {
 		pid = atoi(getstr(list->term));
-		if (pid <= 0) {
-			fail("$&wait", "wait: %d: bad pid", pid);
-			NOTREACHED;
-		}
 	} else {
 		fail("$&wait", "usage: wait [pid]");
 		NOTREACHED;
@@ -195,8 +332,157 @@
 	return mklist(mkstr(mkstatus(ewait(pid, TRUE, NULL))), NULL);
 }
 
+PRIM(fg) {
+	int pid, pgid, status;
+	Proc *proc;
+
+	if (list == NULL || list->next != NULL) {
+		fail("$&fg", "usage: $&fg pid");
+		NOTREACHED;
+	}
+	pid = atoi(getstr(list->term));
+	
+	for (proc = proclist; proc != NULL && proc->pid != pid; proc = proc->next);
+	if (proc == NULL || proc->alive == FALSE) {
+		fail("$&fg", "$&fg: %d: invalid pid", pid);
+		NOTREACHED;
+	}
+	pgid = proc->pgid;
+
+	assign_tty(shell_tty, proc->pgid);
+	tcsetattr(shell_tty, TCSADRAIN, &proc->tmodes);
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if (proc->alive && proc->pgid == pgid) {
+			kill(proc->pid, SIGCONT);
+			proc->background = FALSE;
+			proc->stopped = FALSE;
+		}
+	}
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if (proc->alive && proc->pgid == pgid) {
+                        status = ewait(proc->pid, TRUE, NULL);
+		}
+	}
+        return mklist(mkstr(mkstatus(status)), NULL);
+}
+
+PRIM(bg) {
+	int pid, pgid;
+	Proc *proc;
+	Proc *last=NULL;
+	
+	if (list == NULL || list->next != NULL) {
+		fail("$&bg", "usage: $&bg pid");
+		NOTREACHED;
+	}
+	pid = atoi(getstr(list->term));
+	
+	for (proc = proclist; proc != NULL && proc->pid != pid; proc=proc->next);
+	if (proc == NULL || proc->alive == FALSE) {
+		fail("$&bg", "$&bg: %d: invalid pid", pid);
+		NOTREACHED;
+	}
+	pgid = proc->pgid;
+
+	for (proc = proclist; proc != NULL; proc = proc->next) {
+		if (proc->alive && proc->pgid == pgid) {
+			kill(proc->pid, SIGCONT);
+			proc->background = TRUE;
+			proc->stopped = FALSE;
+			last = proc;
+		}
+	}
+	Ref(List *, l, NULL);
+		l = mklist(mkstr(last == NULL ? "1" : "0"), NULL);
+	RefReturn(l);;
+}
+
+PRIM(procinfo) {
+	Proc *proc;
+	int pid;
+	static char *t = "true", *f = "false";
+
+	if (list == NULL || list->next != NULL) {
+		fail("$&procinfo", "usage: $&procinfo [pid | -pgid]");
+		NOTREACHED;
+	}
+	pid = atoi(getstr(list->term));
+	
+	Ref(List *, l, NULL);
+		for (proc = proclist;
+		     proc != NULL && proc->pid != pid && proc->pgid != -pid;
+		     proc = proc->next);
+		for (; 
+		     pid < 0 && proc->next != NULL && proc->next->pgid == -pid; 
+		     proc = proc->next);
+		if (proc != NULL) {
+			l = mklist(mkstr(str("%d", proc->status)),l); // fixme: cmd last
+			l = mklist(mkstr(str("%s", proc->cmd)),l);
+			l = mklist(mkstr(str("%s", proc->haschanged ? t : f)),l);
+			l = mklist(mkstr(str("%s", proc->stopped ? t : f)),l);
+			l = mklist(mkstr(str("%s", proc->background ? t : f)),l);
+			l = mklist(mkstr(str("%s", proc->alive ? t : f)),l);
+			l = mklist(mkstr(str("%d", proc->pgid)),l);
+			l = mklist(mkstr(str("%d", proc->pid)),l);
+		}
+	RefReturn(l);
+}
+
+
+PRIM(procchange) {
+	Proc *proc;
+	int pid;
+
+	if (list == NULL || list->next != NULL) {
+		fail("$&procchange", "usage: $&procchange pid");
+		NOTREACHED;
+	}
+	pid = atoi(getstr(list->term));
+	
+	for (proc = proclist; proc != NULL && proc->pid != pid; proc = proc->next);
+	if (proc != NULL) {
+		proc->haschanged = !proc->haschanged;
+	}
+	return proc->haschanged ? true : false;
+}
+
+/* Free a process from the proclist. You can shoot in your own foot if you
+ * remove processes which are still alive -- be aware of zombies! */
+PRIM(procfree) {
+	Proc *proc;
+	int pid;
+	
+	if (list == NULL || list->next != NULL) {
+		fail("$&procfree", "usage: $&procfree pid");
+		NOTREACHED;
+	}
+	pid = atoi(getstr(list->term));
+	
+	for (proc = proclist; proc != NULL && proc->pid != pid; proc = proc->next);
+	if (proc == NULL /* || proc->alive == FALSE */) { 
+		fail("$&procfree", "$&procfree: %d: invalid pid", pid);
+		NOTREACHED;
+	}
+	
+	/* Don't leave zombies around. */
+	waitpid(pid, &proc->status, WNOHANG);
+	
+	unlinkproc(&proc);
+	return NULL;
+}
+
+PRIM(donotwait) {
+	return donotwait() ? true : false;
+}
+	
 extern Dict *initprims_proc(Dict *primdict) {
 	X(apids);
 	X(wait);
+	X(fg);
+	X(bg);
+	X(procinfo);
+	X(procfree);
+	X(procchange);
+	X(donotwait);
 	return primdict;
 }
Only in es-0.9-beta1: proc.o
Only in es-0.9-beta1: sigmsgs.c
Only in es-0.9-beta1: sigmsgs.o
diff -u es-0.9-beta1/signal.c es-0.9-job-alpha2/signal.c
--- es-0.9-beta1/signal.c	1997-04-11 14:54:37.000000000 -0600
+++ es-0.9-job-alpha2/signal.c	2002-04-27 17:30:36.000000000 -0600
@@ -26,6 +26,12 @@
 #endif
 #endif
 
+#include <termios.h>
+int has_job_control;
+int shell_pgid;
+int shell_tty;
+struct termios shell_tmodes;
+
 
 /*
  * name<->signal mappings
@@ -61,19 +67,25 @@
 	return str("unknown signal %d", sig);
 }
 
+static Sighandler setsignal(int sig, Sighandler handler);
 
 /*
  * the signal handler
  */
 
 /* catcher -- catch (and defer) a signal from the kernel */
-static void catcher(int sig) {
-#if !SYSV_SIGNALS /* only do this for unreliable signals */
-	signal(sig, catcher);
+extern void catcher(int sig) {
+	int errno_sav=errno;
+
+#if SYSV_SIGNALS /* only do this for unreliable signals */
+		signal(sig, catcher);
 #endif
-	if (hasforked)
+
+	if (hasforked) {
 		/* exit unconditionally on a signal in a child process */
 		exit(1);
+	}
+	
 	if (caught[sig] == 0) {
 		caught[sig] = TRUE;
 		++sigcount;
@@ -81,6 +93,8 @@
 	interrupted = TRUE;
 	if (slow)
 		longjmp(slowlabel, 1);
+
+	errno=errno_sav;
 }
 
 
@@ -153,6 +167,33 @@
 
 
 /*
+ * internal signal blocking
+ */
+
+/* signal blocking stack */
+static sigset_t *sigbs=NULL, *sigbs_tos=NULL, *sigbs_end=NULL;
+
+/* internally blocks a signal */
+extern void block(int sig) {
+	static sigset_t ss, oss;
+	if (sigbs_tos == sigbs_end) {
+		int sz = sigbs_end-sigbs;
+		sigbs = (sigset_t *) erealloc(sigbs, (sz+10)*sizeof(sigbs));
+		sigbs_end = sigbs+sz+10;
+	}
+	sigemptyset(&ss);
+	sigaddset(&ss, sig); 
+	sigprocmask(SIG_BLOCK, &ss, sigbs_tos++);
+	
+}
+
+/* restores the previous sig block mask from the stack */
+extern void unblock(int sig) {  /* sig is only used as reminder */
+	assert(sigbs-sigbs_tos>0);
+	sigprocmask(SIG_SETMASK, --sigbs_tos, NULL);
+}
+
+/*
  * initialization
  */
 
@@ -200,6 +241,25 @@
 			esignal(SIGQUIT, sig_noop);
 	}
 
+	if (interactive) {
+		shell_tty=STDIN_FILENO;
+		shell_pgid=getpid();
+		if (setpgid(shell_pgid,shell_pgid)<0) {
+			has_job_control=0;
+			eprint("Couldn't put es-shell into it's own process group\n");
+		} else {
+			has_job_control=1;
+			assign_tty(shell_tty, shell_pgid);
+			tcgetattr(shell_tty, &shell_tmodes);
+			/* the SIG_DFT action for SIGCHLD is to ignore the signal.
+			 * SIG_IGN is treated special for SIGCHLD! */
+			esignal(SIGCHLD, sig_default);
+			esignal(SIGTTIN, sig_noop);
+			esignal(SIGTTOU, sig_noop);
+			esignal(SIGTSTP, sig_catch);
+		}
+	}	  
+  
 	/* here's the end-run around set-signals */
 	varpush(&settor, "set-signals", NULL);
 	vardef("signals", NULL, mksiglist());
Only in es-0.9-beta1: signal.o
Only in es-0.9-beta1: split.o
diff -u es-0.9-beta1/status.c es-0.9-job-alpha2/status.c
--- es-0.9-beta1/status.c	1997-04-11 14:54:37.000000000 -0600
+++ es-0.9-job-alpha2/status.c	2002-04-28 15:50:55.000000000 -0600
@@ -65,6 +65,10 @@
 
 /* printstatus -- print the status if we should */
 extern void printstatus(int pid, int status) {
+	if (tcgetpgrp(shell_tty) != shell_pgid) {
+		return;
+	}
+	
 	if (SIFSIGNALED(status)) {
 		const char *msg = sigmessage(STERMSIG(status)), *tail = "";
 		if (SCOREDUMP(status)) {
@@ -77,5 +81,6 @@
 				eprint("%s%s\n", msg, tail);
 			else
 				eprint("%d: %s%s\n", pid, msg, tail);
+		return;
 	}
 }
Only in es-0.9-beta1: status.o
diff -u es-0.9-beta1/stdenv.h es-0.9-job-alpha2/stdenv.h
--- es-0.9-beta1/stdenv.h	1997-08-12 17:59:36.000000000 -0600
+++ es-0.9-job-alpha2/stdenv.h	2002-04-17 07:49:06.000000000 -0600
@@ -46,7 +46,7 @@
 #include <signal.h>
 #include <ctype.h>
 
-#if REQUIRE_STAT || REQUIRE_IOCTL
+#if REQUIRE_STAT || REQUIRE_IOCTL || 1
 #include <sys/types.h>
 #endif
 
@@ -268,7 +268,7 @@
 #ifdef HAVE_SETSID
 # define setpgrp(a, b)	setsid()
 #else
-#ifdef linux
+#if defined(linux)
 #include "unistd.h"
 #define setpgrp(a, b)	setpgid(a, b)
 #endif
@@ -297,10 +297,12 @@
  *	terms of the W* forms.
  */
 
-#define	SIFSIGNALED(status)	(((status) & 0xff) != 0)
+#define SIFSTOPPED(status)      ((status) & 0x40)
+#define	SIFEXITED(status)	(!((status) & 0xff))
+#define	SIFSIGNALED(status)	(!SIFEXITED(status) && !SIFSTOPPED(status))
 #define	STERMSIG(status)	((status) & 0x7f)
 #define	SCOREDUMP(status)	((status) & 0x80)
-#define	SIFEXITED(status)	(!SIFSIGNALED(status))
 #define	SEXITSTATUS(status)	(((status) >> 8) & 0xff)
 
 
+
Only in es-0.9-beta1: str.o
Only in es-0.9-beta1: syntax.o
Only in es-0.9-beta1: term.o
Only in es-0.9-beta1: token.h
Only in es-0.9-beta1: token.o
Only in es-0.9-beta1: tree.o
Only in es-0.9-beta1: util.o
Only in es-0.9-beta1: var.o
Only in es-0.9-beta1: vec.o
Only in es-0.9-beta1: version.o
Only in es-0.9-beta1: y.output
Only in es-0.9-beta1: y.tab.c
Only in es-0.9-beta1: y.tab.h
Only in es-0.9-beta1: y.tab.o
